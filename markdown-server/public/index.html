<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📖 Kubernetes学習ドキュメント - MarkdownViewer</title>
    <link rel="stylesheet" href="style.css">
    <!-- Mermaid.js CDN - より安定したバージョン -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Prism.js for Code Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- サイドバー -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>📖 K8s学習ガイド</h2>
                <p>AWS ECS → Kubernetes</p>
            </div>
            
            <div class="search-box">
                <input type="text" id="search" placeholder="🔍 ファイル検索...">
            </div>
            
            <div class="file-tree" id="fileTree">
                <div class="loading">📁 ファイルを読み込み中...</div>
            </div>
        </nav>

        <!-- メインコンテンツエリア -->
        <main class="main-content">
            <header class="content-header">
                <div class="breadcrumb" id="breadcrumb">
                    <span>📖 ドキュメントを選択してください</span>
                </div>
                <div class="toolbar">
                    <button id="toggleSidebar" class="btn-icon" title="サイドバー切り替え">
                        ☰
                    </button>
                    <button id="refreshFiles" class="btn-icon" title="ファイル一覧更新">
                        🔄
                    </button>
                </div>
            </header>
            
            <div class="content-body" id="contentBody">
                <div class="welcome-screen">
                    <h1>🚀 Kubernetes学習ワークスペース</h1>
                    <p class="subtitle">AWS ECS管理者向け包括的学習ガイド</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h3>📖 体系的ドキュメント</h3>
                            <p>公式Kubernetes構造に準拠した学習ガイド</p>
                        </div>
                        <div class="feature-card">
                            <h3>🔄 ECS比較</h3>
                            <p>AWS ECSとの詳細比較で理解促進</p>
                        </div>
                        <div class="feature-card">
                            <h3>🧪 実践演習</h3>
                            <p>段階的なハンズオンラボ</p>
                        </div>
                        <div class="feature-card">
                            <h3>📊 Mermaid図表</h3>
                            <p>インタラクティブな図表表示</p>
                        </div>
                    </div>
                    
                    <div class="quick-links">
                        <h3>🎯 クイックアクセス</h3>
                        <ul>
                            <li><a href="#" onclick="loadFile('README.md')">📋 プロジェクト概要</a></li>
                            <li><a href="#" onclick="loadFile('concepts/overview.md')">📖 Kubernetes概念</a></li>
                            <li><a href="#" onclick="loadFile('tutorials/')">🏃 チュートリアル</a></li>
                            <li><a href="#" onclick="loadFile('tasks/')">📋 実践タスク</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Mermaid初期化設定（最新版対応・安定設定）
        mermaid.initialize({ 
            startOnLoad: false,  // 手動制御
            theme: 'default',
            securityLevel: 'loose',
            deterministicIds: false,
            fontFamily: 'monospace',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            },
            journey: {
                useMaxWidth: true
            },
            timeline: {
                useMaxWidth: true
            }
        });

        let allFiles = [];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadFileList();
            setupEventListeners();
        });

        // イベントリスナーの設定
        function setupEventListeners() {
            // サイドバー切り替え
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // ファイル一覧更新
            document.getElementById('refreshFiles').addEventListener('click', loadFileList);
            
            // 検索機能
            document.getElementById('search').addEventListener('input', filterFiles);
        }

        // ファイル一覧の読み込み
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                allFiles = await response.json();
                renderFileTree(allFiles);
            } catch (error) {
                console.error('ファイル一覧の読み込みに失敗:', error);
                document.getElementById('fileTree').innerHTML = 
                    '<div class="error">❌ ファイル読み込みエラー</div>';
            }
        }

        // ファイルツリーの描画
        function renderFileTree(files) {
            const tree = {};
            
            // ディレクトリ構造を構築
            files.forEach(file => {
                const pathParts = file.relativePath.split('/');
                let current = tree;
                
                pathParts.forEach((part, index) => {
                    if (index === pathParts.length - 1) {
                        current[part] = file;
                    } else {
                        if (!current[part]) current[part] = {};
                        current = current[part];
                    }
                });
            });
            
            const treeHtml = renderTreeNode(tree);
            document.getElementById('fileTree').innerHTML = treeHtml;
        }

        // ツリーノードの描画
        function renderTreeNode(node, depth = 0) {
            let html = '';
            
            Object.keys(node).sort().forEach(key => {
                const item = node[key];
                const indent = '  '.repeat(depth);
                
                if (item.name) {
                    // ファイル
                    html += `
                        <div class="file-item" onclick="loadFile('${item.relativePath}')">
                            ${indent}📄 ${item.name}
                        </div>
                    `;
                } else {
                    // ディレクトリ
                    html += `
                        <div class="folder-item" onclick="toggleFolder(this)">
                            ${indent}📁 ${key}
                        </div>
                        <div class="folder-content">
                            ${renderTreeNode(item, depth + 1)}
                        </div>
                    `;
                }
            });
            
            return html;
        }

        // Markdownファイルの読み込み
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/api/markdown/${filePath}`);
                const data = await response.json();
                
                if (response.ok) {
                    // パンくずリストを更新
                    document.getElementById('breadcrumb').innerHTML = 
                        `📖 ${data.filename} <span class="path">${data.path}</span>`;
                    
                    // コンテンツを表示
                    document.getElementById('contentBody').innerHTML = data.html;
                    
                    // Mermaid図表を安全に再レンダリング
                    await renderMermaidDiagrams();
                    
                    // コードハイライトを適用
                    Prism.highlightAll();
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ファイル読み込みエラー:', error);
                document.getElementById('contentBody').innerHTML = 
                    `<div class="error">❌ ファイルの読み込みに失敗しました: ${error.message}</div>`;
            }
        }

        // Mermaid図表の安全な描画（改良版）
        async function renderMermaidDiagrams() {
            const mermaidElements = document.querySelectorAll('.mermaid:not([data-processed])');
            
            if (mermaidElements.length === 0) {
                console.log('📊 処理すべきMermaid図表はありません');
                return;
            }

            console.log(`📊 ${mermaidElements.length}個のMermaid図表を処理中...`);
            
            for (let i = 0; i < mermaidElements.length; i++) {
                const element = mermaidElements[i];
                const graphDefinition = element.textContent || element.innerText;
                
                // 処理済みマークを追加
                element.setAttribute('data-processed', 'true');
                
                try {
                    // 図表定義の前処理
                    const cleanDefinition = graphDefinition
                        .trim()
                        .replace(/^\s+/gm, '') // 各行の先頭空白を削除
                        .replace(/\r\n/g, '\n'); // 改行の正規化
                    
                    if (!cleanDefinition) {
                        throw new Error('空のMermaid定義です');
                    }

                    // 既存の内容をクリア
                    element.innerHTML = '';
                    element.removeAttribute('data-processed');
                    
                    // 一意のIDを生成
                    const id = `mermaid-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    console.log(`📊 図表 ${i + 1}: ID=${id}`);
                    console.log(`📊 定義:`, cleanDefinition);
                    
                    // Mermaid図表を描画
                    const { svg } = await mermaid.render(id, cleanDefinition);
                    element.innerHTML = svg;
                    element.setAttribute('data-processed', 'success');
                    
                    console.log(`✅ Mermaid図表 ${i + 1} を正常に描画しました`);
                    
                } catch (error) {
                    console.error(`❌ Mermaid図表 ${i + 1} の描画に失敗:`, error);
                    element.setAttribute('data-processed', 'error');
                    element.innerHTML = `
                        <div class="mermaid-error">
                            <h4>⚠️ Mermaid図表エラー</h4>
                            <p><strong>エラー:</strong> ${error.message}</p>
                            <details>
                                <summary>📋 図表定義を表示</summary>
                                <pre>${graphDefinition}</pre>
                            </details>
                            <details>
                                <summary>🔧 デバッグ情報</summary>
                                <pre>Mermaid Version: ${mermaid.version || 'Unknown'}
Error Type: ${error.constructor.name}
Timestamp: ${new Date().toISOString()}</pre>
                            </details>
                        </div>
                    `;
                }
            }
            
            console.log('📊 Mermaid図表の処理が完了しました');
        }

        // ファイル検索
        function filterFiles() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const filteredFiles = allFiles.filter(file => 
                file.name.toLowerCase().includes(searchTerm) ||
                file.relativePath.toLowerCase().includes(searchTerm)
            );
            renderFileTree(filteredFiles);
        }

        // サイドバー切り替え
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }

        // フォルダーの展開/折りたたみ
        function toggleFolder(element) {
            const content = element.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
            
            const icon = element.innerHTML.includes('📁') ? '📂' : '📁';
            element.innerHTML = element.innerHTML.replace(/📁|📂/, icon);
        }
    </script>
</body>
</html>
