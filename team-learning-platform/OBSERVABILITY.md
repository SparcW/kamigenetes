# オブザーバビリティ・ログ集約設計書

## 概要
チーム学習プラットフォーム用のオブザーバビリティスタックを構築し、
開発・運用におけるデバッグ効率を向上させます。

## アーキテクチャ

### ローカル開発環境
```
┌─────────────────────────────────────────────────────────────┐
│                 ローカル開発環境                                │
├─────────────────────────────────────────────────────────────┤
│ アプリケーション                                                │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │   Backend   │ │  Frontend   │ │ Markdown    │            │
│ │ (Node.js)   │ │  (React)    │ │   Server    │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│        │              │              │                     │
│        └──────────────┼──────────────┘                     │
│                       │                                    │
│ オブザーバビリティ                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │   Tempo     │ │ Prometheus  │ │Elasticsearch│            │
│ │(Tracing)    │ │ (Metrics)   │ │   (Logs)    │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│        │              │              │                     │
│        └──────────────┼──────────────┘                     │
│                       │                                    │
│ 可視化                                                       │
│ ┌─────────────┐ ┌─────────────┐                           │
│ │   Grafana   │ │   Kibana    │                           │
│ │(Dashboard)  │ │(Log Search) │                           │
│ └─────────────┘ └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

### Kubernetes環境
```
┌─────────────────────────────────────────────────────────────┐
│                 Kubernetes Cluster                         │
├─────────────────────────────────────────────────────────────┤
│ アプリケーション Pods                                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │   Backend   │ │  Frontend   │ │ Markdown    │            │
│ │    Pod      │ │    Pod      │ │   Server    │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│        │              │              │                     │
│        └──────────────┼──────────────┘                     │
│                       │                                    │
│ オブザーバビリティ Pods                                       │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │ Tempo Stack │ │ Prometheus  │ │ ELK Stack   │            │
│ │ (Operator)  │ │ (Operator)  │ │ (Helm)      │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│        │              │              │                     │
│        └──────────────┼──────────────┘                     │
│                       │                                    │
│ 収集・転送                                                   │
│ ┌─────────────┐ ┌─────────────┐                           │
│ │ OTel        │ │ Fluentd     │                           │
│ │ Collector   │ │ DaemonSet   │                           │
│ └─────────────┘ └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

## 技術スタック

### 1. 分散トレーシング - Grafana Tempo
- **目的**: リクエストフローの可視化、パフォーマンス分析
- **選定理由**: 
  - コスト効率（オブジェクトストレージのみ）
  - Grafanaとのネイティブ統合
  - TraceQL による強力なクエリ機能
- **代替案**: Jaeger（より重い）、Zipkin（機能限定）

### 2. メトリクス - Prometheus + Grafana
- **目的**: システムメトリクス、ビジネスメトリクス収集
- **収集対象**:
  - Node.js アプリケーションメトリクス
  - PostgreSQL, Redis メトリクス
  - Kubernetes クラスターメトリクス
  - カスタムビジネスメトリクス（学習進捗、ユーザー行動）

### 3. ログ管理 - Elasticsearch + Kibana
- **目的**: 構造化ログの検索・分析
- **ログ種別**:
  - アプリケーションログ（構造化JSON）
  - アクセスログ（Nginx）
  - エラーログ（統合エラー追跡）
  - 監査ログ（認証、権限変更）

### 4. 統合収集 - OpenTelemetry
- **目的**: 統一された観測データ収集
- **対応形式**: トレース、メトリクス、ログ
- **SDK統合**: Node.js、React（RUM）

## 主要機能

### 1. 分散トレーシング
- **ユーザー学習フロー追跡**
  - ログイン → コンテンツ閲覧 → クイズ → 進捗更新
- **API パフォーマンス監視**
  - データベースクエリ時間
  - Redis アクセス時間
  - 外部API呼び出し時間
- **エラー追跡**
  - 例外発生箇所の特定
  - エラー伝播の可視化

### 2. メトリクス監視
- **システムメトリクス**
  - CPU、メモリ、ネットワーク使用率
  - データベース接続数、クエリ実行時間
  - Redis ヒット率、メモリ使用量
- **ビジネスメトリクス**
  - アクティブユーザー数
  - 学習進捗率
  - クイズ正答率
  - チーム活動状況

### 3. ログ分析
- **構造化ログ**
  - JSON形式での統一ログ出力
  - 相関ID による追跡
  - ログレベル別集計
- **セキュリティログ**
  - 認証試行ログ
  - 権限変更ログ
  - 不正アクセス検知

### 4. アラート機能
- **システムアラート**
  - 高CPU使用率
  - データベース接続エラー
  - API レスポンス時間異常
- **ビジネスアラート**
  - 学習進捗率低下
  - エラー率上昇
  - ユーザー活動異常

## 実装段階

### Phase 1: ローカル開発環境
1. Docker Compose にオブザーバビリティサービス追加
2. Backend に OpenTelemetry SDK 統合
3. Frontend に RUM (Real User Monitoring) 統合
4. Grafana ダッシュボード作成

### Phase 2: Kubernetes環境
1. Tempo Operator デプロイ
2. Prometheus Operator デプロイ
3. ELK Stack Helm Chart デプロイ
4. Fluentd DaemonSet 構成

### Phase 3: 運用最適化
1. アラートルール設定
2. SLI/SLO 定義
3. 自動スケーリング連携
4. 長期データ保持戦略

## ポート・エンドポイント

### ローカル開発環境
- **Grafana**: http://localhost:3100
- **Prometheus**: http://localhost:9090
- **Tempo**: http://localhost:3200
- **Elasticsearch**: http://localhost:9200
- **Kibana**: http://localhost:5601

### Kubernetes環境
- **Grafana**: https://grafana.team-learning.local
- **Prometheus**: https://prometheus.team-learning.local
- **Kibana**: https://kibana.team-learning.local

## セキュリティ考慮事項

1. **認証・認可**
   - Grafana, Kibana の認証設定
   - RBAC による権限管理

2. **データ保護**
   - 機密情報のマスキング
   - 個人情報の匿名化

3. **ネットワーク**
   - TLS 通信の強制
   - 内部ネットワークの分離

## 運用メトリクス

### Golden Signals
1. **Latency**: API応答時間
2. **Traffic**: リクエスト数
3. **Errors**: エラー率
4. **Saturation**: リソース使用率

### SLI/SLO例
- **API可用性**: 99.9%
- **応答時間**: 95%ile < 200ms
- **エラー率**: < 0.1%
- **データ保持**: 30日間

## 次のステップ

1. Docker Compose 設定ファイル作成
2. OpenTelemetry SDK 統合
3. ダッシュボード・アラート設定
4. Kubernetes マニフェスト作成
5. 運用手順書作成
