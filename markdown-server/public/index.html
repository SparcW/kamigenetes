<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“– Kuberneteså­¦ç¿’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - MarkdownViewer</title>
    <link rel="stylesheet" href="style.css">
    <!-- Mermaid.js CDN - ã‚ˆã‚Šå®‰å®šã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Prism.js for Code Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ“– K8så­¦ç¿’ã‚¬ã‚¤ãƒ‰</h2>
                <p>AWS ECS â†’ Kubernetes</p>
            </div>
            
            <div class="search-box">
                <input type="text" id="search" placeholder="ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢...">
            </div>
            
            <div class="file-tree" id="fileTree">
                <div class="loading">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </nav>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <main class="main-content">
            <header class="content-header">
                <div class="breadcrumb" id="breadcrumb">
                    <span>ğŸ“– ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                </div>
                <div class="toolbar">
                    <button id="toggleSidebar" class="btn-icon" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆ">
                        â˜°
                    </button>
                    <button id="refreshFiles" class="btn-icon" title="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æ›´æ–°">
                        ğŸ”„
                    </button>
                </div>
            </header>
            
            <div class="content-body" id="contentBody">
                <div class="welcome-screen">
                    <h1>ğŸš€ Kuberneteså­¦ç¿’ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</h1>
                    <p class="subtitle">AWS ECSç®¡ç†è€…å‘ã‘åŒ…æ‹¬çš„å­¦ç¿’ã‚¬ã‚¤ãƒ‰</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h3>ğŸ“– ä½“ç³»çš„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</h3>
                            <p>å…¬å¼Kubernetesæ§‹é€ ã«æº–æ‹ ã—ãŸå­¦ç¿’ã‚¬ã‚¤ãƒ‰</p>
                        </div>
                        <div class="feature-card">
                            <h3>ğŸ”„ ECSæ¯”è¼ƒ</h3>
                            <p>AWS ECSã¨ã®è©³ç´°æ¯”è¼ƒã§ç†è§£ä¿ƒé€²</p>
                        </div>
                        <div class="feature-card">
                            <h3>ğŸ§ª å®Ÿè·µæ¼”ç¿’</h3>
                            <p>æ®µéšçš„ãªãƒãƒ³ã‚ºã‚ªãƒ³ãƒ©ãƒœ</p>
                        </div>
                        <div class="feature-card">
                            <h3>ğŸ“Š Mermaidå›³è¡¨</h3>
                            <p>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå›³è¡¨è¡¨ç¤º</p>
                        </div>
                    </div>
                    
                    <div class="quick-links">
                        <h3>ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹</h3>
                        <ul>
                            <li><a href="#" onclick="loadFile('README.md')">ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</a></li>
                            <li><a href="#" onclick="loadFile('concepts/overview.md')">ğŸ“– Kubernetesæ¦‚å¿µ</a></li>
                            <li><a href="#" onclick="loadFile('tutorials/')">ğŸƒ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a></li>
                            <li><a href="#" onclick="loadFile('tasks/')">ğŸ“‹ å®Ÿè·µã‚¿ã‚¹ã‚¯</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // MermaidåˆæœŸåŒ–è¨­å®šï¼ˆæœ€æ–°ç‰ˆå¯¾å¿œãƒ»å®‰å®šè¨­å®šï¼‰
        mermaid.initialize({ 
            startOnLoad: false,  // æ‰‹å‹•åˆ¶å¾¡
            theme: 'default',
            securityLevel: 'loose',
            deterministicIds: false,
            fontFamily: 'monospace',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            },
            journey: {
                useMaxWidth: true
            },
            timeline: {
                useMaxWidth: true
            }
        });

        let allFiles = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadFileList();
            setupEventListeners();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æ›´æ–°
            document.getElementById('refreshFiles').addEventListener('click', loadFileList);
            
            // æ¤œç´¢æ©Ÿèƒ½
            document.getElementById('search').addEventListener('input', filterFiles);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                allFiles = await response.json();
                renderFileTree(allFiles);
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                document.getElementById('fileTree').innerHTML = 
                    '<div class="error">âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã®æç”»
        function renderFileTree(files) {
            const tree = {};
            
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’æ§‹ç¯‰
            files.forEach(file => {
                const pathParts = file.relativePath.split('/');
                let current = tree;
                
                pathParts.forEach((part, index) => {
                    if (index === pathParts.length - 1) {
                        current[part] = file;
                    } else {
                        if (!current[part]) current[part] = {};
                        current = current[part];
                    }
                });
            });
            
            const treeHtml = renderTreeNode(tree);
            document.getElementById('fileTree').innerHTML = treeHtml;
        }

        // ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰ã®æç”»
        function renderTreeNode(node, depth = 0) {
            let html = '';
            
            Object.keys(node).sort().forEach(key => {
                const item = node[key];
                const indent = '  '.repeat(depth);
                
                if (item.name) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«
                    html += `
                        <div class="file-item" onclick="loadFile('${item.relativePath}')">
                            ${indent}ğŸ“„ ${item.name}
                        </div>
                    `;
                } else {
                    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
                    html += `
                        <div class="folder-item" onclick="toggleFolder(this)">
                            ${indent}ğŸ“ ${key}
                        </div>
                        <div class="folder-content">
                            ${renderTreeNode(item, depth + 1)}
                        </div>
                    `;
                }
            });
            
            return html;
        }

        // Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/api/markdown/${filePath}`);
                const data = await response.json();
                
                if (response.ok) {
                    // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    document.getElementById('breadcrumb').innerHTML = 
                        `ğŸ“– ${data.filename} <span class="path">${data.path}</span>`;
                    
                    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                    document.getElementById('contentBody').innerHTML = data.html;
                    
                    // Mermaidå›³è¡¨ã‚’å®‰å…¨ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    await renderMermaidDiagrams();
                    
                    // ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
                    Prism.highlightAll();
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('contentBody').innerHTML = 
                    `<div class="error">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
            }
        }

        // Mermaidå›³è¡¨ã®å®‰å…¨ãªæç”»ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        async function renderMermaidDiagrams() {
            const mermaidElements = document.querySelectorAll('.mermaid:not([data-processed])');
            
            if (mermaidElements.length === 0) {
                console.log('ğŸ“Š å‡¦ç†ã™ã¹ãMermaidå›³è¡¨ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            console.log(`ğŸ“Š ${mermaidElements.length}å€‹ã®Mermaidå›³è¡¨ã‚’å‡¦ç†ä¸­...`);
            
            for (let i = 0; i < mermaidElements.length; i++) {
                const element = mermaidElements[i];
                const graphDefinition = element.textContent || element.innerText;
                
                // å‡¦ç†æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
                element.setAttribute('data-processed', 'true');
                
                try {
                    // å›³è¡¨å®šç¾©ã®å‰å‡¦ç†
                    const cleanDefinition = graphDefinition
                        .trim()
                        .replace(/^\s+/gm, '') // å„è¡Œã®å…ˆé ­ç©ºç™½ã‚’å‰Šé™¤
                        .replace(/\r\n/g, '\n'); // æ”¹è¡Œã®æ­£è¦åŒ–
                    
                    if (!cleanDefinition) {
                        throw new Error('ç©ºã®Mermaidå®šç¾©ã§ã™');
                    }

                    // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                    element.innerHTML = '';
                    element.removeAttribute('data-processed');
                    
                    // ä¸€æ„ã®IDã‚’ç”Ÿæˆ
                    const id = `mermaid-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    console.log(`ğŸ“Š å›³è¡¨ ${i + 1}: ID=${id}`);
                    console.log(`ğŸ“Š å®šç¾©:`, cleanDefinition);
                    
                    // Mermaidå›³è¡¨ã‚’æç”»
                    const { svg } = await mermaid.render(id, cleanDefinition);
                    element.innerHTML = svg;
                    element.setAttribute('data-processed', 'success');
                    
                    console.log(`âœ… Mermaidå›³è¡¨ ${i + 1} ã‚’æ­£å¸¸ã«æç”»ã—ã¾ã—ãŸ`);
                    
                } catch (error) {
                    console.error(`âŒ Mermaidå›³è¡¨ ${i + 1} ã®æç”»ã«å¤±æ•—:`, error);
                    element.setAttribute('data-processed', 'error');
                    element.innerHTML = `
                        <div class="mermaid-error">
                            <h4>âš ï¸ Mermaidå›³è¡¨ã‚¨ãƒ©ãƒ¼</h4>
                            <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                            <details>
                                <summary>ğŸ“‹ å›³è¡¨å®šç¾©ã‚’è¡¨ç¤º</summary>
                                <pre>${graphDefinition}</pre>
                            </details>
                            <details>
                                <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
                                <pre>Mermaid Version: ${mermaid.version || 'Unknown'}
Error Type: ${error.constructor.name}
Timestamp: ${new Date().toISOString()}</pre>
                            </details>
                        </div>
                    `;
                }
            }
            
            console.log('ğŸ“Š Mermaidå›³è¡¨ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
        function filterFiles() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const filteredFiles = allFiles.filter(file => 
                file.name.toLowerCase().includes(searchTerm) ||
                file.relativePath.toLowerCase().includes(searchTerm)
            );
            renderFileTree(filteredFiles);
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
        function toggleFolder(element) {
            const content = element.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
            
            const icon = element.innerHTML.includes('ğŸ“') ? 'ğŸ“‚' : 'ğŸ“';
            element.innerHTML = element.innerHTML.replace(/ğŸ“|ğŸ“‚/, icon);
        }
    </script>
</body>
</html>
