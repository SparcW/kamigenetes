# Phase 2: é«˜åº¦ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Ÿè£…

## ğŸ“– æ¦‚è¦

ã“ã®Phaseã§ã¯ã€Gateway APIã®é«˜åº¦ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã‚’å­¦ç¿’ã—ã€ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã€é‡ã¿ä»˜ããƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ğŸ¯ å­¦ç¿’ç›®æ¨™

- ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®Ÿè£…
- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®š
- ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²ï¼ˆA/Bãƒ†ã‚¹ãƒˆã€Canary deploymentï¼‰
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›
- ReferenceGrantã«ã‚ˆã‚‹ã‚¯ãƒ­ã‚¹åå‰ç©ºé–“ã‚¢ã‚¯ã‚»ã‚¹

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gateway   â”‚
â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ HTTPRoute (è¤‡æ•°ãƒ«ãƒ¼ãƒ«)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API v1   â”‚    API v2   â”‚  Frontend   â”‚
â”‚   Service   â”‚   Service   â”‚   Service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚
    â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API v1     â”‚  API v2     â”‚  Frontend   â”‚
â”‚   Pods      â”‚   Pods      â”‚    Pods     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ AWS ECSã¨ã®æ¯”è¼ƒ

| æ©Ÿèƒ½ | AWS ALB | Gateway API HTTPRoute |
|------|---------|----------------------|
| **ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°** | ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ« | HTTPRoute matches.path |
| **ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°** | ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ« | HTTPRoute matches.headers |
| **é‡ã¿ä»˜ããƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°** | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®é‡ã¿ | backendRefs.weight |
| **ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤‰æ›** | Lambda@Edge | HTTPRoute filters |
| **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯** | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ— | Kubernetesãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |

## ğŸ“‹ å‰ææ¡ä»¶

- Phase 1ã®å®Œäº†
- Gateway API CRDs
- NGINX Gateway Fabricï¼ˆã¾ãŸã¯ä»–ã®Gatewayå®Ÿè£…ï¼‰

## ğŸš€ å®Ÿç¿’æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# Phase 1ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
kubectl get gateway demo-gateway -n gateway-demo

# Phase 2ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
./setup.sh
```

### ã‚¹ãƒ†ãƒƒãƒ—2: é«˜åº¦ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

```bash
# å„ç¨®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
./test.sh

# å€‹åˆ¥ãƒ†ã‚¹ãƒˆ
./test-path-routing.sh
./test-header-routing.sh
./test-traffic-splitting.sh
```

### ã‚¹ãƒ†ãƒƒãƒ—3: A/Bãƒ†ã‚¹ãƒˆã®ç¢ºèª

```bash
# ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²ã®ç¢ºèª
for i in {1..10}; do
  curl -H "Host: advanced.example.com" http://<GATEWAY-IP>/api/v1
done
```

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
phase2-advanced-routing/
â”œâ”€â”€ README.md              # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ setup.sh              # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ test.sh               # åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ test-path-routing.sh  # ãƒ‘ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ test-header-routing.sh # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ test-traffic-splitting.sh # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ cleanup.sh            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ manifests/
â”‚   â”œâ”€â”€ namespace.yaml    # è¿½åŠ åå‰ç©ºé–“
â”‚   â”œâ”€â”€ advanced-gateway.yaml # é«˜åº¦ãªGatewayè¨­å®š
â”‚   â”œâ”€â”€ path-based-route.yaml # ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”œâ”€â”€ header-based-route.yaml # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”œâ”€â”€ traffic-split-route.yaml # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²
â”‚   â”œâ”€â”€ request-modifier-route.yaml # ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤‰æ›
â”‚   â””â”€â”€ apps/
â”‚       â”œâ”€â”€ api-v1/       # API v1ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”œâ”€â”€ api-v2/       # API v2ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”œâ”€â”€ frontend/     # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â””â”€â”€ canary/       # Canaryã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â””â”€â”€ docs/
    â”œâ”€â”€ routing-concepts.md # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¦‚å¿µ
    â””â”€â”€ traffic-management.md # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç®¡ç†
```

## ğŸ“š å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

### 1. ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```yaml
# ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä¾‹
rules:
- matches:
  - path:
      type: PathPrefix
      value: "/api/v1"
  backendRefs:
  - name: api-v1-service
    port: 80
- matches:
  - path:
      type: PathPrefix
      value: "/api/v2"
  backendRefs:
  - name: api-v2-service
    port: 80
```

**AWS ALBæ¯”è¼ƒ**: ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«

### 2. ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```yaml
# ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä¾‹
rules:
- matches:
  - headers:
    - name: "x-api-version"
      value: "v2"
  backendRefs:
  - name: api-v2-service
    port: 80
```

**AWS ALBæ¯”è¼ƒ**: ãƒ˜ãƒƒãƒ€ãƒ¼æ¡ä»¶ä»˜ããƒ«ãƒ¼ãƒ«

### 3. ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²

```yaml
# é‡ã¿ä»˜ããƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä¾‹
rules:
- matches:
  - path:
      type: PathPrefix
      value: "/api"
  backendRefs:
  - name: api-stable-service
    port: 80
    weight: 90
  - name: api-canary-service
    port: 80
    weight: 10
```

**AWS ALBæ¯”è¼ƒ**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®é‡ã¿è¨­å®š

### 4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤‰æ›

```yaml
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤‰æ›ã®ä¾‹
rules:
- matches:
  - path:
      type: PathPrefix
      value: "/old-api"
  filters:
  - type: URLRewrite
    urlRewrite:
      path:
        type: ReplacePrefixMatch
        replacePrefixMatch: "/api/v2"
  backendRefs:
  - name: api-v2-service
    port: 80
```

**AWS ALBæ¯”è¼ƒ**: Lambda@Edgeã‚„ALBã®çµ„ã¿è¾¼ã¿å¤‰æ›

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ãªã„**
   ```bash
   kubectl describe httproute <route-name> -n <namespace>
   kubectl get httproute <route-name> -n <namespace> -o yaml
   ```

2. **ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†å‰²ãŒæ©Ÿèƒ½ã—ãªã„**
   ```bash
   # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
   kubectl get services -n <namespace>
   kubectl get endpoints -n <namespace>
   ```

3. **ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å•é¡Œ**
   ```bash
   # ãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã®ç¢ºèª
   curl -H "x-api-version: v2" -H "Host: example.com" http://<GATEWAY-IP>/
   ```

## ğŸ“ˆ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 2ãŒå®Œäº†ã—ãŸã‚‰ã€Phase 3ã¸é€²ã‚“ã§ãã ã•ã„ï¼š
- [Phase 3: ãƒãƒ«ãƒãƒ—ãƒ­ãƒˆã‚³ãƒ«å¯¾å¿œ](../phase3-multi-protocol/README.md)

ã“ã®Phaseã§ã¯ä»¥ä¸‹ã‚’å­¦ç¿’ã—ã¾ã™ï¼š
- TCPRouteã®å®Ÿè£…
- UDPRouteã®å®Ÿè£…
- TLSRouteã¨SSLçµ‚ç«¯

---

## ğŸ¤” ç·´ç¿’å•é¡Œ

1. **ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼**: `x-client-type: mobile` ã§ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
2. **è¤‡åˆæ¡ä»¶**: ãƒ‘ã‚¹ + ãƒ˜ãƒƒãƒ€ãƒ¼ã®çµ„ã¿åˆã‚ã›ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
3. **æ®µéšçš„ã‚«ãƒŠãƒªãƒ¼**: 5% â†’ 25% â†’ 50% â†’ 100% ã®æ®µéšçš„ç§»è¡Œ

è§£ç­”ä¾‹ã¯ `solutions/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
